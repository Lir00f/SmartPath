"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const errors_1 = require("./errors");
const index_1 = __importDefault(require("./index"));
/**
 * Connection options.
 * This wrapper is constructed from a plain object or a URI string.
 *
 * It is capable of parsing them, and providing an interface to the rest of the code to:
 * - Build parameters to create sequelize instances
 * - Build connections options with both dialect and sslmode resolved (for quick startup in cloud)
 * - Provide safe urls for error messages (without credentials)
 * - Play with the host and port without breaking SSL servername / error messages (for the proxy)
 */
class ConnectionOptions {
    /**
     * Database URI without credentials, which can be used in error messages.
     * Ensure that this is never substituted by the proxy, nor that it includes credentials.
     */
    get debugDatabaseUri() {
        const dialect = this.dialect ?? '?';
        const port = this.initialPort ?? '?';
        const database = this.database ?? '?';
        return dialect === 'sqlite'
            ? this.uri?.href ?? `sqlite:${this.sequelizeOptions.storage}`
            : `${dialect}://${this.initialHost}:${port}/${database}`;
    }
    get dialect() {
        let dialect = this.uri?.protocol?.slice(0, -1) || this.sequelizeOptions.dialect;
        if (dialect === 'mysql2')
            dialect = 'mysql';
        else if (dialect === 'tedious')
            dialect = 'mssql';
        else if (dialect === 'pg' || dialect === 'postgresql')
            dialect = 'postgres';
        return dialect;
    }
    get host() {
        return this.uri?.hostname ?? this.sequelizeOptions.host ?? 'localhost';
    }
    get port() {
        let port = Number(this.uri?.port) || this.sequelizeOptions.port;
        if (!port) {
            // Use default port for known dialects otherwise
            if (this.dialect === 'postgres')
                port = 5432;
            else if (this.dialect === 'mssql')
                port = 1433;
            else if (this.dialect === 'mysql' || this.dialect === 'mariadb')
                port = 3306;
        }
        return port;
    }
    get database() {
        return this.uri?.pathname?.slice(1) || this.sequelizeOptions.database;
    }
    get plainConnectionOptions() {
        const options = { ...this.sequelizeOptions };
        if (this.uri)
            options.uri = this.uri.toString();
        if (this.proxyOptions)
            options.proxySocks = this.proxyOptions;
        if (this.sshOptions)
            options.ssh = this.sshOptions;
        if (this.connectionTimeoutInMs)
            options.connectionTimeoutInMs = this.connectionTimeoutInMs;
        options.dialect = this.dialect;
        options.sslMode = this.sslMode;
        return options;
    }
    constructor(options, logger) {
        this.logger = logger;
        if (typeof options === 'string') {
            this.uri = this.parseDatabaseUri(options);
            this.sequelizeOptions = {};
        }
        else {
            const { uri, sslMode, proxySocks, ssh, connectionTimeoutInMs, ...sequelizeOptions } = options;
            this.proxyOptions = proxySocks;
            this.sshOptions = ssh;
            this.connectionTimeoutInMs = connectionTimeoutInMs;
            this.sequelizeOptions = sequelizeOptions;
            this.sslMode = sslMode ?? 'manual';
            this.uri = uri ? this.parseDatabaseUri(uri) : null;
        }
        // Save initial host & port (for SSL and error messages)
        this.initialHost = this.host;
        this.initialPort = this.port;
        // Check required options
        if (!this.dialect)
            throw new errors_1.DatabaseConnectError(`Dialect is required`, this.debugDatabaseUri);
        if (this.dialect !== 'sqlite' && !this.port)
            throw new errors_1.DatabaseConnectError(`Port is required`, this.debugDatabaseUri);
    }
    changeHostAndPort(host, port) {
        // Host
        if (this.uri)
            this.uri.hostname = host;
        else
            this.sequelizeOptions.host = host;
        // Port
        if (this.uri)
            this.uri.port = String(port);
        else
            this.sequelizeOptions.port = port;
    }
    async buildPreprocessedOptions() {
        const options = this.plainConnectionOptions;
        options.sslMode = await this.computeSslMode();
        return options;
    }
    /** Options that can be passed to the sequelize constructor */
    async buildSequelizeCtorOptions() {
        const options = { ...this.sequelizeOptions };
        options.dialect = this.dialect;
        options.logging = this.makeSequelizeLogging();
        options.schema = this.makeSequelizeSchema();
        options.dialectOptions = {
            ...(options.dialectOptions ?? {}),
            ...(await this.makeSequelizeDialectOptions()),
        };
        return this.uri ? [this.uri.toString(), options] : [options];
    }
    parseDatabaseUri(str) {
        const message = `Connection Uri "${str}" provided to SQL data source is not valid. ` +
            `Should be <dialect>://<connection>.`;
        if (!str.startsWith('sqlite') && !/.*:\/\//g.test(str))
            throw new errors_1.DatabaseConnectError(message, str);
        try {
            return new URL(str);
        }
        catch {
            throw new errors_1.DatabaseConnectError(message, str);
        }
    }
    /** Helper to fill the sequelize's options.schema  */
    makeSequelizeSchema() {
        return this.uri?.searchParams.get('schema') || this.sequelizeOptions.schema || null;
    }
    /** Helper to fill the sequelize's options.logging */
    makeSequelizeLogging() {
        return this.logger
            ? (sql) => this.logger?.('Debug', sql.substring(sql.indexOf(':') + 2))
            : false;
    }
    /** Helper to fill the sequelize's options.dialectOptions */
    async makeSequelizeDialectOptions() {
        const sslMode = await this.computeSslMode();
        switch (this.dialect) {
            case 'mariadb':
                if (sslMode === 'disabled')
                    return { ssl: false };
                if (sslMode === 'required')
                    return { ssl: { rejectUnauthorized: false } };
                if (sslMode === 'verify')
                    return { ssl: true };
                break;
            case 'mssql':
                if (sslMode === 'disabled')
                    return { options: { encrypt: false } };
                if (sslMode === 'required')
                    return { options: { encrypt: true, trustServerCertificate: true } };
                if (sslMode === 'verify')
                    return { options: { encrypt: true, trustServerCertificate: false } };
                break;
            case 'mysql':
                if (sslMode === 'disabled')
                    return { ssl: false };
                if (sslMode === 'required')
                    return { ssl: { rejectUnauthorized: false } };
                if (sslMode === 'verify')
                    return { ssl: { rejectUnauthorized: true } };
                break;
            case 'postgres':
                if (sslMode === 'disabled')
                    return { ssl: false };
                // Pass servername to the net.tlsSocket constructor.
                // This is done so that
                // - Certificate verification still work when using a proxy server to reach the db (we are
                //   forced to use a tcp reverse proxy because some drivers do not support them)
                // - Providers which use SNI to route requests to the correct database still work (most
                //   notably neon.tech).
                // Note that we should either do that for the other vendors (if possible), or
                // replace the reverse proxy by a forward proxy (when supported).
                if (sslMode === 'required')
                    return {
                        ssl: { require: true, rejectUnauthorized: false, servername: this.initialHost },
                    };
                if (sslMode === 'verify')
                    return { ssl: { require: true, rejectUnauthorized: true, servername: this.initialHost } };
                break;
            case 'db2':
            case 'oracle':
            case 'snowflake':
            case 'sqlite':
            default:
                if (sslMode && sslMode !== 'manual') {
                    this.logger?.('Warn', `ignoring sslMode=${sslMode} (not supported for ${this.dialect})`);
                }
                return {};
        }
    }
    async computeSslMode() {
        if (this.sslMode !== 'preferred') {
            return this.sslMode ?? 'manual';
        }
        // When NODE_TLS_REJECT_UNAUTHORIZED is set to 0, we skip the 'verify' mode, as we know it will
        // always work locally, but not when deploying to another environment.
        const modes = ['verify', 'required', 'disabled'];
        if (process.env.NODE_TLS_REJECT_UNAUTHORIZED === '0')
            modes.shift();
        let error;
        for (const sslMode of modes) {
            let sequelize;
            try {
                // eslint-disable-next-line no-await-in-loop
                sequelize = await (0, index_1.default)(new ConnectionOptions({ ...this.plainConnectionOptions, sslMode }));
                return sslMode;
            }
            catch (e) {
                error = e;
            }
            finally {
                await sequelize?.close(); // eslint-disable-line no-await-in-loop
            }
        }
        throw error;
    }
}
exports.default = ConnectionOptions;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdGlvbi1vcHRpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2Nvbm5lY3Rpb24vY29ubmVjdGlvbi1vcHRpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBR0EscUNBQWdEO0FBQ2hELG9EQUE4QjtBQVM5Qjs7Ozs7Ozs7O0dBU0c7QUFDSCxNQUFxQixpQkFBaUI7SUFZcEM7OztPQUdHO0lBQ0gsSUFBSSxnQkFBZ0I7UUFDbEIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxHQUFHLENBQUM7UUFDcEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsSUFBSSxHQUFHLENBQUM7UUFDckMsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsSUFBSSxHQUFHLENBQUM7UUFFdEMsT0FBTyxPQUFPLEtBQUssUUFBUTtZQUN6QixDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLElBQUksVUFBVSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFO1lBQzdELENBQUMsQ0FBQyxHQUFHLE9BQU8sTUFBTSxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksSUFBSSxRQUFRLEVBQUUsQ0FBQztJQUM3RCxDQUFDO0lBRUQsSUFBSSxPQUFPO1FBQ1QsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUM7UUFDaEYsSUFBSSxPQUFPLEtBQUssUUFBUTtZQUFFLE9BQU8sR0FBRyxPQUFPLENBQUM7YUFDdkMsSUFBSSxPQUFPLEtBQUssU0FBUztZQUFFLE9BQU8sR0FBRyxPQUFPLENBQUM7YUFDN0MsSUFBSSxPQUFPLEtBQUssSUFBSSxJQUFJLE9BQU8sS0FBSyxZQUFZO1lBQUUsT0FBTyxHQUFHLFVBQVUsQ0FBQztRQUU1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