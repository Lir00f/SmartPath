"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class Service {
    get error() {
        return this.errors.length > 0 ? this.errors[0] : null;
    }
    get debugUri() {
        return `${this.sourceHost}:${this.sourcePort}`;
    }
    get debugForwardUri() {
        return `${this.targetHost}:${this.targetPort}`;
    }
    constructor(sourceHost, sourcePort, targetHost, targetPort) {
        this.connectedClients = new Set();
        this.errors = [];
        this.sourceHost = sourceHost;
        this.sourcePort = sourcePort;
        this.targetHost = targetHost;
        this.targetPort = targetPort;
    }
    /** link a service */
    link(service) {
        this.linkedService = service;
    }
    /** stop the service by stopping the linked service and destroying all its clients. */
    async stop() {
        try {
            await this.linkedService?.stop();
        }
        finally {
            this.connectedClients.forEach(client => client.destroy());
        }
    }
    /** call the linked service connection callback */
    async connect(socket) {
        return (await this.linkedService?.connect(socket)) || socket;
    }
    /** destroy the given socket if it is not closed and save the error */
    destroySocketIfUnclosedAndSaveError(socket, error) {
        if (error)
            this.errors.push(error);
        if (socket) {
            if (!socket.closed)
                socket.destroy();
            this.connectedClients.delete(socket);
        }
    }
    /** register a socket as a client to be destroyed when the service is stopped */
    addConnectedClient(client) {
        this.connectedClients.add(client);
    }
}
exports.default = Service;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb25uZWN0aW9uL3NlcnZpY2VzL3NlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFLQSxNQUE4QixPQUFPO0lBU25DLElBQUksS0FBSztRQUNQLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDeEQsQ0FBQztJQUVELElBQWMsUUFBUTtRQUNwQixPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDakQsQ0FBQztJQUVELElBQWMsZUFBZTtRQUMzQixPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDakQsQ0FBQztJQUVELFlBQVksVUFBa0IsRUFBRSxVQUFrQixFQUFFLFVBQWtCLEVBQUUsVUFBa0I7UUFuQnpFLHFCQUFnQixHQUFvQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzVDLFdBQU0sR0FBWSxFQUFFLENBQUM7UUFtQnRDLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO0lBQy9CLENBQUM7SUFFRCxxQkFBcUI7SUFDckIsSUFBSSxDQUFDLE9BQWdCO1FBQ25CLElBQUksQ0FBQyxhQUFhLEdBQUcsT0FBTyxDQUFDO0lBQy9CLENBQUM7SUFFRCxzRkFBc0Y7SUFDdEYsS0FBSyxDQUFDLElBQUk7UUFDUixJQUFJO1lBQ0YsTUFBTSxJQUFJLENBQUMsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDO1NBQ2xDO2dCQUFTO1lBQ1IsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1NBQzNEO0lBQ0gsQ0FBQztJQUVELGtEQUFrRDtJQUN4QyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQW1CO1FBQ3pDLE9BQU8sQ0FBQyxNQUFNLElBQUksQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDO0lBQy9ELENBQUM7SUFFRCxzRUFBc0U7SUFDNUQsbUNBQW1DLENBQUMsTUFBbUIsRUFBRSxLQUFhO1FBQzlFLElBQUksS0FBSztZQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRW5DLElBQUksTUFBTSxFQUFFO1lBQ1YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNO2dCQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNyQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3RDO0lBQ0gsQ0FBQztJQUVELGdGQUFnRjtJQUN0RSxrQkFBa0IsQ0FBQyxNQUFrQjtRQUM3QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3BDLENBQUM7Q0FDRjtBQTdERCwwQkE2REMifQ==